{% extends "base.html" %}
{% block content %}
<h2>Configs</h2>

<div class="mt-3">
    <div id="uploadAlert" class="alert d-none" role="alert">
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>

<div class="d-flex justify-content-between mb-3">
  <form method="get" class="d-flex align-items-center">
    <label for="deviceSelect" class="me-2 fw-semibold">Device:</label>
    <select id="deviceSelect" name="device" class="form-select" style="width: 200px;" onchange="this.form.submit()">
      {% for device in devices %}
      <option value="{{ device.name }}" {% if device.name == selected_device.name %}selected{% endif %}>
      {{ device.name }}
      </option>
      {% endfor %}
    </select>
  </form>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConfigModal">
    <i class="bi bi-plus"></i> Add new config
  </button>
</div>

<table class="table table-bordered device-table">
  <thead class="table-light">
    <tr>
      <th>Name</th>
      <th style="width: 20%">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for cfg in configs %}
    <tr>
      <td>{{ cfg.name }}</td>
      <td>
        <button class="btn btn-remove btn-sm"><i class="bi bi-trash"></i> Remove</button>
        <button class="btn btn-download btn-sm"><i class="bi bi-download"></i> Download</button>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="3" class="text-center text-muted">No configs found</td></tr>
    {% endfor %}
  </tbody>
</table>

<div class="modal fade" id="addConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Add New Config</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <!-- Device selection -->
        <div class="mb-3">
          <label for="cfgDeviceSelect" class="form-label">Device</label>
          <select class="form-select" id="cfgDeviceSelect" name="device" multiple required>
            {% for device in devices %}
            <option value="{{ device.url }}" {% if device.name == 'Local device' %}selected{% endif %}>{{ device.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="configFile" class="form-label">Config file</label>
            <input type="file" id="configFile" name="file" accept=".yaml,.yml" class="form-control" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Upload</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const selectedDevice = {{ selected_device | tojson }}

document.querySelectorAll(".btn-remove").forEach(btn => {
  btn.addEventListener("click", async e => {
    const row = e.target.closest("tr");
    const name = row.querySelector("td").textContent.trim();
    if (!confirm(`Delete config "${name}"?`)) return;
    const resp = await fetch(`${selectedDevice.url}/api/v1/configs/${name}`, { method: "DELETE" });
    if (resp.ok) {
      location.reload();
    } else {
      alert("Failed to delete config");
    }
  });
});


function showAlert(message, type) {
  const uploadAlert = document.getElementById("uploadAlert");
  uploadAlert.textContent = message;
  uploadAlert.className = `alert alert-dismissible fade show alert-${type}`;
}

document.getElementById("uploadForm").addEventListener("submit", async e => {
  e.preventDefault();
  const selectedDevices = Array.from(cfgDeviceSelect.selectedOptions).map(opt => opt.value);
  const modal = bootstrap.Modal.getInstance(document.getElementById("addConfigModal"));
  for (const deviceUrl of selectedDevices) {
    try {
      const formData = new FormData(e.target);
      const resp = await fetch(`${deviceUrl}/api/v1/configs`, {
        method: "POST",
        body: formData
      });
      const data = await resp.json();
      if (!resp.ok) {
        modal.hide();
        showAlert(data.error || "Upload failed", "danger");
        return;
      }
    } catch (err) {
        console.error(`Error uploading config to ${deviceUrl}:`, err);

        showAlert("Upload failed" + err.message, "danger");
    }
  }
  modal.hide();
  location.reload();
});

document.querySelectorAll(".btn-download").forEach(btn => {
  btn.addEventListener("click", async e => {
    const row = e.target.closest("tr");
    const name = row.querySelector("td").textContent.trim();

    const resp = await fetch(`${selectedDevice.url}/api/v1/configs/${name}/file`);
    if (!resp.ok) {
      alert("Failed to download config file");
      return;
    }

    const blob = await resp.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  });
});

document.getElementById('deviceSelect').addEventListener('change', function() {
  window.location.href = `/configs?device=${encodeURIComponent(deviceId)}`;
  const deviceId = this.value;
});
</script>
{% endblock %}
