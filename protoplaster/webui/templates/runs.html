{% extends "base.html" %}
{% block content %}
<h2>Test runs</h2>

<div class="d-flex justify-content-end mb-3">
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#triggerTestRunModal">
    <i class="bi bi-play-fill"></i> Trigger test run
  </button>
</div>

{% for device in devices %}
<div class="card mb-3 device-container" data-device-url="{{ device.url }}">

  <!-- Header (name + badge)  -->
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <button class="btn btn-link text-decoration-none text-dark fw-bold p-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}">
        <i class="bi bi-chevron-down me-2"></i> {{ device.name }}
      </button>
      {% if device.runs is none %}
      <span class="badge bg-secondary ms-2">Offline</span>
      {% endif %}
    </h5>
  </div>

  <!-- Device tests -->
  <div id="collapse-{{ loop.index }}" class="collapse show">
  <table class="table table-bordered device-table mb-0">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Config</th>
        <th>Status</th>
        <th>Started</th>
        <th>Finished</th>
        <th style="width: 20%">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% if device.runs %}
      {% for run in device.runs %}
      <tr data-run-id="{{ run.id }}">
        <td>{{ run.id }}</td>
        <td>{{ run.config_name }}</td>
        <td class="status-cell" data-status="{{ run.status }}"></td>
        <td class="start-cell">{{ run.started_at or '-' }}</td>
        <td class="end-cell">{{ run.finished_at or '-' }}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary btn-details" data-run-id="{{ run.id }}">Details</button>
          <button class="btn btn-sm btn-outline-danger btn-abort" data-run-id="{{ run.id }}" {% if run.status != 'pending' %}disabled{% endif %}>Abort</button>
        </td>
      </tr>
      {% endfor %}
      {% else %}
      <tr><td colspan="6" class="text-center text-muted">No test runs</td></tr>
      {% endif %}
    </tbody>
  </table>
  </div>

</div>
{% endfor %}

<!-- Trigger Test Run Modal -->
<div class="modal fade" id="triggerTestRunModal" tabindex="-1" aria-labelledby="triggerTestRunModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="triggerRunForm">
        <div class="modal-header">
          <h5 class="modal-title" id="triggerTestRunModalLabel">Trigger Test Run</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <!-- Device selection -->
          <div class="mb-3">
            <label for="runDeviceSelect" class="form-label">Device</label>
            <select class="form-select" id="runDeviceSelect" name="device" multiple required>
              {% for device in devices %}
              <option value="{{ device.url }}" {% if device.name == 'Local device' %}selected{% endif %}>{{ device.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Config selection -->
          <div class="mb-3">
            <label for="configSelect" class="form-label">Config</label>
            <select class="form-select" id="configSelect" name="config">
            </select>
          </div>

          <div class="mb-3">
            <label for="testSuiteName" class="form-label">Test suite</label>
            <input type="text" name="name" class="form-control" id="testSuiteName">
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Trigger</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Test Details Modal -->
<div class="modal fade" id="testDetailsModal" tabindex="-1" aria-labelledby="testDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="testDetailsModalLabel">Test Run Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <dl class="row">
          <dt class="col-sm-3">Run ID</dt><dd class="col-sm-9" id="detail-id">-</dd>
          <dt class="col-sm-3">Config</dt><dd class="col-sm-9" id="detail-config">-</dd>
          <dt class="col-sm-3">Status</dt><dd class="col-sm-9" id="detail-status">-</dd>
          <dt class="col-sm-3">Start time</dt><dd class="col-sm-9" id="detail-start">-</dd>
          <dt class="col-sm-3">Finish time</dt><dd class="col-sm-9" id="detail-end">-</dd>
        </dl>
        <h6>Artifacts</h6>
        <ul id="artifact-list" class="list-group mb-3">
          <li class="list-group-item text-muted">No artifacts</li>
        </ul>
        <h6>Test Results</h6>
        <div class="table-responsive border rounded mb-3">
          <div id="results-container"></div>
        </div>
        <div class="text-end">
          <a id="report-link" href="#" class="btn btn-outline-secondary" target="_blank">
            <i class="bi bi-file-earmark-text"></i> Download CSV Report
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const statusMap = {
    finished: ['success', 'Passed'],
    failed: ['danger', 'Failed'],
    pending: ['secondary', 'Pending'],
    running: ['warning text-dark', 'Running'],
    aborted: ['secondary', 'Aborted']
  };

  const updateRow = (row, data) => {
    const [cls, text] = statusMap[data.status];
    row.querySelector('.status-cell').innerHTML = `<span class="badge bg-${cls}">${text}</span>`;
    row.querySelector('.start-cell').textContent = data.started_at || '-';
    row.querySelector('.end-cell').textContent = data.finished_at || '-';
    row.querySelector('.btn-abort').disabled = data.status !== 'pending';
  };

  document.querySelectorAll('tr[data-run-id]').forEach(row => {
      const status = row.querySelector('.status-cell').dataset.status;
      if (status) updateRow(row, {
        status: status, 
        started_at: row.querySelector('.start-cell').textContent,
        finished_at: row.querySelector('.end-cell').textContent
      });
  });

  const poll = async () => {
    document.querySelectorAll('.device-container').forEach(async container => {
      const deviceUrl = container.dataset.deviceUrl;
      try {
        const resp = await fetch(`${deviceUrl}/api/v1/test-runs`);
        if (!resp.ok) return;

        const runs = await resp.json();
        for (const run of runs) {
          const row = container.querySelector(`tr[data-run-id="${run.id}"]`);
          if (row) updateRow(row, run);
        }
      } catch (err) {
        console.error(`Failed to fetch test runs:`, err);
      }
    });
  };

  setInterval(poll, {{polling_interval * 1000 }});

  async function fetchConfigs(deviceUrl) {
    try {
      const resp = await fetch(`${deviceUrl}/api/v1/configs`);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const configs = await resp.json();
      return configs.map(cfg => cfg.name);
    } catch (err) {
      console.error(`Failed to fetch configs from ${deviceUrl}:`, err);
      return [];
    }
  }

  function getIntersectMap(arr, map) {
    const returnMap = new Map()
    for (let i = 0; i < arr.length; i++) {
      if (!map.size) {
        returnMap.set(arr[i], i)
      } else {
        if (map.has(arr[i]) && !returnMap.has(arr[i])) {
          returnMap.set(arr[i], i)
        }
      }
    }
    return returnMap
  }

  function getIntersection(arrays) {
    const initialMap = new Map()
    const resultMap = arrays?.reduce(function _(acc, currentVal) {
      return getIntersectMap(currentVal, acc)
    }, initialMap)

    return Array.from(resultMap.keys())
  }

  async function updateConfigList() {
    const configSelect = document.getElementById('configSelect');
    const runDeviceSelect = document.getElementById('runDeviceSelect');
    const selectedDevices = Array.from(runDeviceSelect.selectedOptions).map(opt => opt.value);

    configSelect.innerHTML = '<option disabled>Loading...</option>';

    if (selectedDevices.length === 0) {
      configSelect.innerHTML = '<option disabled>Select at least one device</option>';
      return;
    }

    // Fetch config lists in parallel
    const allConfigs = await Promise.all(selectedDevices.map(fetchConfigs));
    commonConfigs = getIntersection(allConfigs);

    // Populate dropdown
    configSelect.innerHTML = '';
    if (commonConfigs.length === 0) {
      configSelect.innerHTML = '<option disabled>No common configs found!</option>';
    } else {
      commonConfigs.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        configSelect.appendChild(opt);
      });
    }
  }

  const modal = document.getElementById('triggerTestRunModal');
  modal.addEventListener('show.bs.modal', updateConfigList);
  document.getElementById('runDeviceSelect').addEventListener('change', updateConfigList);

  function canArtifactOpen(contentType) {
    return contentType === "application/json"
          || contentType === "application/pdf"
          || ["text", "image", "audio", "video"].includes(contentType.split("/")[0]);
  }

  // Trigger run form
  document.getElementById('triggerRunForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const config = document.getElementById('configSelect').value;
    const testSuite = document.getElementById('testSuiteName').value;
    const selectedDevices = Array.from(runDeviceSelect.selectedOptions).map(opt => opt.value);

    for (const deviceUrl of selectedDevices) {
      try {
        const resp = await fetch(`${deviceUrl}/api/v1/test-runs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config_name: config, test_suite_name: testSuite}),
        });
      } catch (err) {
        console.error(`Error triggering on ${deviceUrl}:`, err);
      }
    }
    location.reload();
  });

  // Abort button
  document.querySelectorAll('.btn-abort').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      if (!confirm("Are you sure you want to abort this test run?")) return;

      const btn = e.target.closest("button");
      const id = btn.dataset.runId;
      const deviceUrl = btn.closest(".device-container").dataset.deviceUrl;
      try {
        const resp = await fetch(`${deviceUrl}/api/v1/test-runs/${id}`, { method: 'DELETE' });
        if (!resp.ok) {
          const data = await resp.json();
          alert(`Failed to abort: ${data.error || resp.statusText}`);
        } else {
          // Refresh statuses
          poll();
        }
      } catch (err) {
        console.error("Error aborting run:", err);
        alert("An error occurred while trying to abort the run.");
      }
    });
  });

  // Details modal
  document.querySelectorAll('.btn-details').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const btn = e.target.closest("button");
      const id = btn.dataset.runId;
      const deviceUrl = btn.closest(".device-container").dataset.deviceUrl;
      
      const resp = await fetch(`${deviceUrl}/api/v1/test-runs/${id}`);
      if (!resp.ok) return alert('Failed to fetch run details');
      const data = await resp.json();

      const resp_art = await fetch(`${deviceUrl}/api/v1/test-runs/${id}/artifacts`);
      if (!resp_art.ok) return alert('Failed to fetch run artifacts');
      const data_art = await resp_art.json();

      document.getElementById('detail-id').textContent = data.id;
      document.getElementById('detail-config').textContent = data.config_name;
      document.getElementById('detail-status').textContent = data.status;
      document.getElementById('detail-start').textContent = data.started_at || '-';
      document.getElementById('detail-end').textContent = data.finished_at || '-';

      // Populate artifacts
      const artifactList = document.getElementById('artifact-list');
      artifactList.innerHTML = '';
      if (data_art && data_art.length > 0) {
        const contentTypes = await Promise.all(data_art.map(async (artifact) => {
            const url =  `${deviceUrl}/api/v1/test-runs/${id}/artifacts/${encodeURIComponent(artifact.name)}`;
            return [url, await fetch(url, { method: 'HEAD' })
                .then(r => r.ok && r.headers.get('Content-Type'))
                .catch(console.error)]
        }));
        data_art.forEach((artifact, i) => {
          const [url, contentType] = contentTypes[i];
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.textContent = artifact.name;
          const buttons = document.createElement('div');
          const buttonClasses = 'btn btn-sm btn-outline-primary';
          if (contentType && canArtifactOpen(contentType)) {
            const openButton = document.createElement('a');
            openButton.href = `${url}?preview=true`;
            openButton.className = buttonClasses;
            openButton.textContent = 'Open';
            openButton.style["margin-right"] = '1em';
            buttons.appendChild(openButton);
          } 
          const downloadButton = document.createElement('a');
          downloadButton.href = url;
          downloadButton.className = buttonClasses;
          downloadButton.textContent = 'Download';
          buttons.appendChild(downloadButton);
          li.appendChild(buttons)
          artifactList.appendChild(li);
        });
      } else {
        artifactList.innerHTML = '<li class="list-group-item text-muted">No artifacts</li>';
      }

      // Fetch test results table
      const resultsContainer = document.getElementById('results-container');
      resultsContainer.innerHTML = '<div class="text-center text-muted p-3">Loading...</div>';
      const resp_report = await fetch(`${deviceUrl}/api/v1/test-runs/${id}/report?format=html`);
      if (resp_report.ok) {
        resultsContainer.innerHTML = await resp_report.text();
      } else {
        resultsContainer.innerHTML = '<div class="text-center text-muted p-3">No results found.</div>';
      }

      // Report link
      const reportLink = document.getElementById('report-link');
      reportLink.href = `${deviceUrl}/api/v1/test-runs/${id}/report`;

      new bootstrap.Modal(document.getElementById('testDetailsModal')).show();
    });
  });
});
</script>
{% endblock %}

